#ifndef __Input_h__
#define __Input_h__

#include <vector>

#include <maya/MCallbackIdArray.h>
#include <maya/MDataBlock.h>
#include <maya/MDataHandle.h>
#include <maya/MMessage.h>
#include <maya/MPlug.h>


// #include <HAPI/HAPI_Common.h>
#include "HoudiniApi.h"

class Input;

class Inputs
{
public:
    Inputs(HAPI_NodeId nodeId);
    ~Inputs();

    MStatus compute(MDataBlock &dataBlock);

    void setNumInputs(int numInputs);

private:
    HAPI_NodeId myNodeId;

    typedef std::vector<Input *> AssetInputVector;
    AssetInputVector myAssetInputs;
};

class Input
{
public:
    enum AssetInputType
    {
        AssetInputType_Invalid,
        AssetInputType_Mesh,
        AssetInputType_Curve,
        AssetInputType_Particle,
    };

    static Input *createAssetInput(AssetInputType assetInputType);

public:
    Input();
    virtual ~Input();

    virtual AssetInputType assetInputType() const = 0;

    HAPI_NodeId transformNodeId() const { return myTransformNodeId; };
    HAPI_NodeId geometryNodeId() const { return myGeometryNodeId; };
    void setUnlockNormals(bool unlockNormals);
    void setMatPerFace(bool matPerFace);
    void setAllowFacetSet(bool allowFacetSet);
    void setPreserveScale(bool preserveScale);

    void setInputName(HAPI_AttributeOwner owner, int count, const MPlug &plug);

    void setInputTransform(MDataHandle &dataHandle);

    virtual void setInputGeo(MDataBlock &dataBlock, const MPlug &plug) = 0;

    virtual void setInputComponents(MDataBlock &dataBlock,
                                    const MPlug &geoPlug,
                                    const MPlug &compPlug,
                                    const MPlug &primGroupPlug,
                                    const MPlug &pointGroupPlug);

protected:
    void setTransformNodeId(HAPI_NodeId nodeId) { myTransformNodeId = nodeId; };
    void setGeometryNodeId(HAPI_NodeId nodeId) { myGeometryNodeId = nodeId; };

    bool myUnlockNormals;
    bool myMatPerFace;
    bool myAllowFacetSet;
    bool myPreserveScale;

private:
    static void nameChangedCallback(MObject &node,
                                    const MString &str,
                                    void *clientData);
    void addNameChangedCallback(MObject &node);
    void removeNameChangedCallback();

private:
    HAPI_NodeId myTransformNodeId;
    HAPI_NodeId myGeometryNodeId;

    MPlug myGeoPlug;

    MCallbackIdArray myNameChangedCallbackIds;
    MObject myNameChangedCallbackNode;
};

#endif

